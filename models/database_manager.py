from datetime import datetime
from typing import List, Dict, Optional
from contextlib import contextmanager
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker, aliased
from sqlalchemy.exc import IntegrityError
from .users import Base, User, UserType, AnswerStat
from .logs import ScoreChangeLog, OperationLog
from .groups import Group
from sqlalchemy.orm import relationship, configure_mappers


# –ö–ª–∞—Å—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
class DatabaseManager:
    def __init__(self, db_url="sqlite:///users.db"):
        self.engine = create_engine(db_url)
        Base.metadata.create_all(self.engine)
        self.Session = sessionmaker(bind=self.engine, expire_on_commit=False)

    @contextmanager
    def get_session(self):
        """–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
        session = self.Session()
        try:
            yield session
            session.commit()
        except Exception as e:
            session.rollback()
            raise e
        finally:
            session.close()

    def drop_tables(self):
        """–£–¥–∞–ª—è–µ—Ç –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)"""
        Base.metadata.drop_all(self.engine)

    def init_db(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö (—Å–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—ã)"""
        Base.metadata.create_all(self.engine)

    # –ú–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ª–æ–≥–∞–º–∏ (–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –∏–∑ logs.py)
    def log_operation(self, user_id, operation_type):
        """–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –ª–æ–≥ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö"""
        with self.get_session() as session:
            log_entry = OperationLog(
                user_id=user_id,
                operation_type=operation_type
            )
            session.add(log_entry)

    def get_operation_logs(self, user_id=None, operation_type=None, limit=100):
        """–ü–æ–ª—É—á–∞–µ—Ç –ª–æ–≥–∏ –æ–ø–µ—Ä–∞—Ü–∏–π"""
        with self.get_session() as session:
            query = session.query(OperationLog).order_by(OperationLog.created_at.desc())

            if user_id:
                query = query.filter(OperationLog.user_id == user_id)

            if operation_type:
                query = query.filter(OperationLog.operation_type == operation_type)

            logs = query.limit(limit).all()

            return [{
                'id': log.id,
                'user_id': log.user_id,
                'operation_type': log.operation_type,
                'created_at': log.created_at,
                'username': log.user.username if log.user else None
            } for log in logs]

    def get_score_change_log(self, user_id=None, limit=50):
        """–ü–æ–ª—É—á–∞–µ—Ç –ª–æ–≥–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –±–∞–ª–ª–æ–≤"""
        with self.get_session() as session:
            UserAlias1 = aliased(User)
            UserAlias2 = aliased(User)

            query = session.query(
                ScoreChangeLog,
                UserAlias1.username.label('user_username'),
                UserAlias2.username.label('changer_username')
            ).join(
                UserAlias1, ScoreChangeLog.user_id == UserAlias1.id
            ).join(
                UserAlias2, ScoreChangeLog.changed_by_id == UserAlias2.id
            ).order_by(ScoreChangeLog.change_time.desc())

            if user_id:
                query = query.filter(ScoreChangeLog.user_id == user_id)

            results = query.limit(limit).all()

            logs = []
            for log_entry, user_username, changer_username in results:
                logs.append({
                    'id': log_entry.id,
                    'user_id': log_entry.user_id,
                    'changed_by_id': log_entry.changed_by_id,
                    'old_score': log_entry.old_score,
                    'new_score': log_entry.new_score,
                    'delta': log_entry.delta,
                    'change_time': log_entry.change_time,
                    'user_username': user_username,
                    'changer_username': changer_username
                })

            return logs

    # –ú–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –∏–∑ users.py)
    def get_or_create_user(self, user_id, username, user_type=UserType.STUDENT):
        """–ü–æ–ª—É—á–∞–µ—Ç –∏–ª–∏ —Å–æ–∑–¥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        with self.get_session() as session:
            user = session.get(User, user_id)
            if user:
                if user.username != username:
                    user.username = username
                if user.user_type != user_type and user_type != UserType.STUDENT:
                    user.user_type = user_type
                return user
            else:
                # üëá –î–û–ë–ê–í–¨ –≠–¢–û–¢ –ö–û–î üëá
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º –∏–∑ .env
                import os
                admin_ids_str = os.getenv("ADMIN_IDS", "")
                if admin_ids_str:
                    admin_ids = [int(id.strip()) for id in admin_ids_str.split(",") if id.strip()]
                    if user_id in admin_ids:
                        user_type = UserType.ADMIN
                        print(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} —Å–æ–∑–¥–∞–Ω –∫–∞–∫ –ê–î–ú–ò–ù (–∏–∑ ADMIN_IDS)")
                # üëÜ –ö–û–ù–ï–¶ –î–û–ë–ê–í–õ–ï–ù–ù–û–ì–û –ö–û–î–ê üëÜ

                user = User(
                    id=user_id,
                    username=username,
                    user_type=user_type,
                    last_request_date=datetime.now().date()
                )
                session.add(user)
                return user
    def register_user_request(self, user_id):
        """–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        today = datetime.now().date()
        with self.get_session() as session:
            user = session.get(User, user_id)
            if user:
                if user.last_request_date != today:
                    user.requests_today = 1
                    user.last_request_date = today
                else:
                    user.requests_today += 1

    def update_existing_admins(self):
        """–û–±–Ω–æ–≤–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ ADMIN_IDS –≤ –∞–¥–º–∏–Ω—ã"""
        import os
        admin_ids_str = os.getenv("ADMIN_IDS", "")
        if not admin_ids_str:
            return

        admin_ids = [int(id.strip()) for id in admin_ids_str.split(",") if id.strip()]

        with self.get_session() as session:
            for admin_id in admin_ids:
                user = session.get(User, admin_id)
                if user and user.user_type != UserType.ADMIN:
                    print(f"üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {admin_id} –¥–æ –∞–¥–º–∏–Ω–∞")
                    user.user_type = UserType.ADMIN

    def can_user_request(self, user_id, max_attempts=100):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –º–æ–∂–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å"""
        today = datetime.now().date()
        with self.get_session() as session:
            user = session.get(User, user_id)

            if not user:
                return max_attempts

            if user.last_request_date != today:
                return max_attempts

            remaining = max_attempts - user.requests_today
            return remaining if remaining > 0 else 0

    def update_score(self, user_id, delta, changed_by_id=None):
        """–û–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–ª—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º"""
        with self.get_session() as session:
            user = session.get(User, user_id)
            if not user:
                raise ValueError(f"User with id {user_id} not found")

            if changed_by_id:
                changer = session.get(User, changed_by_id)
                if not changer:
                    raise ValueError(f"Changer with id {changed_by_id} not found")

                # –õ–æ–≥–∏—Ä—É–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–∞–ª–ª–æ–≤
                self.log_operation(
                    user_id=changed_by_id,
                    operation_type='change_score'
                )

                old_score, new_score = changer.change_user_score(user, delta, session)
                return old_score, new_score
            else:
                old_score = user.score
                user.score += delta
                return old_score, user.score

    def get_score(self, user_id):
        """–ü–æ–ª—É—á–∞–µ—Ç –±–∞–ª–ª—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        with self.get_session() as session:
            user = session.get(User, user_id)
            return user.score if user else 0

    def get_top_players(self, limit=3):
        """–ü–æ–ª—É—á–∞–µ—Ç —Ç–æ–ø –∏–≥—Ä–æ–∫–æ–≤"""
        with self.get_session() as session:
            users = session.query(User) \
                .filter(User.user_type == UserType.STUDENT) \
                .order_by(User.score.desc()) \
                .limit(limit).all()
            return [{'username': user.username, 'score': user.score} for user in users]

    def get_user_position(self, user_id):
        """–ü–æ–ª—É—á–∞–µ—Ç –ø–æ–∑–∏—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ"""
        with self.get_session() as session:
            users = session.query(User) \
                .filter(User.user_type == UserType.STUDENT) \
                .order_by(User.score.desc()).all()

            for idx, user in enumerate(users, start=1):
                if user.id == user_id:
                    return idx, user.score

            return len(users) + 1, 0

    def get_full_rating(self):
        """–ü–æ–ª—É—á–∞–µ—Ç –ø–æ–ª–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥"""
        with self.get_session() as session:
            users = session.query(User) \
                .filter(User.user_type == UserType.STUDENT) \
                .order_by(User.score.desc()).all()
            return [{'id': user.id, 'username': user.username, 'score': user.score}
                    for user in users]

    def get_user_requests_today(self, user_id):
        """–ü–æ–ª—É—á–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–µ–≥–æ–¥–Ω—è"""
        with self.get_session() as session:
            user = session.get(User, user_id)
            return user.requests_today if user else 0

    def change_user_type(self, user_id, new_type, changed_by_id=None):
        """–ò–∑–º–µ–Ω—è–µ—Ç —Ç–∏–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        with self.get_session() as session:
            user = session.get(User, user_id)
            if not user:
                raise ValueError(f"User with id {user_id} not found")

            old_type = user.user_type
            user.user_type = new_type

            # –õ–æ–≥–∏—Ä—É–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if changed_by_id:
                self.log_operation(
                    user_id=changed_by_id,
                    operation_type='change_user_type'
                )

            return old_type, new_type

    def get_user(self, user_id):
        """–ü–æ–ª—É—á–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID"""
        with self.get_session() as session:
            return session.get(User, user_id)

    def get_users_by_type(self, user_type):
        """–ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞"""
        with self.get_session() as session:
            return session.query(User).filter(User.user_type == user_type).all()

    # –ú–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –æ—Ç–≤–µ—Ç–æ–≤
    def increment_correct(self, name):
        """–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å—á–µ—Ç—á–∏–∫ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤"""
        with self.get_session() as session:
            stat = session.query(AnswerStat).filter(AnswerStat.name == name).first()
            if not stat:
                stat = AnswerStat(name=name, correct_cnt=1)
                session.add(stat)
            else:
                stat.correct_cnt += 1

    def increment_wrong(self, name):
        """–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤"""
        with self.get_session() as session:
            stat = session.query(AnswerStat).filter(AnswerStat.name == name).first()
            if not stat:
                stat = AnswerStat(name=name, wrong_cnt=1)
                session.add(stat)
            else:
                stat.wrong_cnt += 1

    def get_stats(self, name):
        """–ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∏–º–µ–Ω–∏"""
        with self.get_session() as session:
            stat = session.query(AnswerStat).filter(AnswerStat.name == name).first()
            if stat:
                return {"correct_cnt": stat.correct_cnt, "wrong_cnt": stat.wrong_cnt}
            return {"correct_cnt": 0, "wrong_cnt": 0}

    def get_top_strategies(self, limit=4):
        """–ü–æ–ª—É—á–∞–µ—Ç —Ç–æ–ø —Å—Ç—Ä–∞—Ç–µ–≥–∏–π"""
        with self.get_session() as session:
            stats = session.query(AnswerStat) \
                .filter(AnswerStat.name != 'none') \
                .order_by((AnswerStat.correct_cnt + AnswerStat.wrong_cnt).desc()) \
                .limit(limit).all()

            return [{
                'name': stat.name,
                'correct_cnt': stat.correct_cnt,
                'wrong_cnt': stat.wrong_cnt,
                'total': stat.correct_cnt + stat.wrong_cnt
            } for stat in stats]

    # –ú–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≥—Ä—É–ø–ø–∞–º–∏ (–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –∏–∑ groups.py)
    def create_group(self, name, max_students=25, transfer_deadline=None):
        """–°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é –≥—Ä—É–ø–ø—É"""
        with self.get_session() as session:
            group = Group(name=name, max_students=max_students, transfer_deadline=transfer_deadline)
            session.add(group)
            return group

    def get_group(self, group_id):
        """–ü–æ–ª—É—á–∞–µ—Ç –≥—Ä—É–ø–ø—É –ø–æ ID"""
        with self.get_session() as session:
            return session.get(Group, group_id)

    def get_all_groups(self):
        """–ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –≥—Ä—É–ø–ø—ã"""
        with self.get_session() as session:
            return session.query(Group).all()

    def set_user_group(self, user_id, group_id, changed_by_id=None):
        """–ù–∞–∑–Ω–∞—á–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥—Ä—É–ø–ø—É (–∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –≤—Å–µ–≥–¥–∞, —Å—Ç—É–¥–µ–Ω—Ç - —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏)"""
        with self.get_session() as session:
            user = session.get(User, user_id)
            if not user:
                raise ValueError(f"User with id {user_id} not found")

            group = session.get(Group, group_id)
            if not group:
                raise ValueError(f"Group with id {group_id} not found")

            old_group = user.group

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞
            if changed_by_id:
                changer = session.get(User, changed_by_id)
                if changer and changer.user_type == UserType.ADMIN:
                    # –ê–¥–º–∏–Ω –º–æ–∂–µ—Ç –≤—Å–µ–≥–¥–∞ –º–µ–Ω—è—Ç—å –≥—Ä—É–ø–ø—É
                    user.group = group

                    # –õ–æ–≥–∏—Ä—É–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é
                    self.log_operation(
                        user_id=changed_by_id,
                        operation_type='admin_change_group'
                    )

                    return old_group, group
                elif changer and changer.id == user_id:
                    # –°—Ç—É–¥–µ–Ω—Ç –ø—ã—Ç–∞–µ—Ç—Å—è —Å–º–µ–Ω–∏—Ç—å —Å–≤–æ—é –≥—Ä—É–ø–ø—É
                    return self._student_change_group(user, group, session)
                else:
                    raise PermissionError("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è —Å–º–µ–Ω—ã –≥—Ä—É–ø–ø—ã")
            else:
                # –°–∏—Å—Ç–µ–º–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
                user.group = group
                return old_group, group

    def _student_change_group(self, user, new_group, session):
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–º–µ–Ω—É –≥—Ä—É–ø–ø—ã —Å—Ç—É–¥–µ–Ω—Ç–æ–º"""
        if user.user_type != UserType.STUDENT:
            raise PermissionError("–¢–æ–ª—å–∫–æ —Å—Ç—É–¥–µ–Ω—Ç—ã –º–æ–≥—É—Ç –º–µ–Ω—è—Ç—å –≥—Ä—É–ø–ø—ã —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
        can_join, message = new_group.can_join()
        if not can_join:
            raise ValueError(message)

        old_group = user.group
        user.group = new_group

        # –õ–æ–≥–∏—Ä—É–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é
        self.log_operation(
            user_id=user.id,
            operation_type='student_change_group'
        )

        return old_group, new_group

    def set_transfer_deadline(self, group_id, deadline, changed_by_id):
        """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –¥–µ–¥–ª–∞–π–Ω –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ –≥—Ä—É–ø–ø—É (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω)"""
        with self.get_session() as session:
            group = session.get(Group, group_id)
            if not group:
                raise ValueError(f"Group with id {group_id} not found")

            changer = session.get(User, changed_by_id)
            if not changer or changer.user_type != UserType.ADMIN:
                raise PermissionError("–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –¥–µ–¥–ª–∞–π–Ω")

            old_deadline = group.transfer_deadline
            group.transfer_deadline = deadline

            # –õ–æ–≥–∏—Ä—É–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é
            self.log_operation(
                user_id=changed_by_id,
                operation_type='set_transfer_deadline'
            )

            return old_deadline, deadline

    def get_group_students(self, group_id):
        """–ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≤ –≥—Ä—É–ø–ø–µ"""
        with self.get_session() as session:
            group = session.get(Group, group_id)
            if group:
                return [s for s in group.students if s.user_type == UserType.STUDENT]
            return []

    def get_available_groups_for_student(self, user_id):
        """–ü–æ–ª—É—á–∞–µ—Ç –≥—Ä—É–ø–ø—ã, –≤ –∫–æ—Ç–æ—Ä—ã–µ —Å—Ç—É–¥–µ–Ω—Ç –º–æ–∂–µ—Ç –ø–µ—Ä–µ–π—Ç–∏"""
        with self.get_session() as session:
            user = session.get(User, user_id)
            if not user or user.user_type != UserType.STUDENT:
                return []

            all_groups = session.query(Group).all()
            available_groups = []

            for group in all_groups:
                can_join, message = group.can_join()
                current_group_id = user.group.id if user.group else None
                if can_join and group.id != current_group_id:
                    student_count = len([s for s in group.students if s.user_type == UserType.STUDENT])
                    available_groups.append({
                        'id': group.id,
                        'name': group.name,
                        'current_students': student_count,
                        'max_students': group.max_students,
                        'transfer_deadline': group.transfer_deadline
                    })

            return available_groups

    # –ú–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–µ–π—Ç–∏–Ω–≥–æ–º
    def save_rating(self, user_id, group_id=None, rating_type='group', rank=None, 
                    grade=None, score=None, excluded=False, cdf_value=None):
        """
        –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ü–µ–Ω–∫—É –∑–∞ —Å–µ–º–∏–Ω–∞—Ä—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            group_id: ID –≥—Ä—É–ø–ø—ã (None –¥–ª—è –æ–±—â–µ–≥–æ —Ä–µ–π—Ç–∏–Ω–≥–∞)
            rating_type: –¢–∏–ø —Ä–µ–π—Ç–∏–Ω–≥–∞ ('group' –∏–ª–∏ 'overall')
            rank: –ü–æ–∑–∏—Ü–∏—è –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ
            grade: –û—Ü–µ–Ω–∫–∞ –∑–∞ —Å–µ–º–∏–Ω–∞—Ä—ã (0-10)
            score: –ë–∞–ª–ª—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            excluded: –ò—Å–∫–ª—é—á–µ–Ω –ª–∏ –∏–∑ —Ä–∞—Å—á–µ—Ç–∞
            cdf_value: –ó–Ω–∞—á–µ–Ω–∏–µ CDF –¥–ª—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
        """
        with self.get_session() as session:
            user = session.get(User, user_id)
            if user:
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ü–µ–Ω–∫—É –∑–∞ —Å–µ–º–∏–Ω–∞—Ä—ã –≤ –∫–æ–ª–æ–Ω–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if grade is not None:
                    user.seminar_grade = grade

    def get_ratings_from_db(self, group_id=None, rating_type='group'):
        """
        –ü–æ–ª—É—á–∞–µ—Ç —Ä–µ–π—Ç–∏–Ω–≥ –∏–∑ –ë–î (—á–∏—Ç–∞–µ—Ç –∏–∑ –∫–æ–ª–æ–Ω–∫–∏ seminar_grade –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
        
        Args:
            group_id: ID –≥—Ä—É–ø–ø—ã (None –¥–ª—è –æ–±—â–µ–≥–æ —Ä–µ–π—Ç–∏–Ω–≥–∞)
            rating_type: –¢–∏–ø —Ä–µ–π—Ç–∏–Ω–≥–∞ ('group' –∏–ª–∏ 'overall')
            
        Returns:
            –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ä–µ–π—Ç–∏–Ω–≥–µ –∏–ª–∏ None, –µ—Å–ª–∏ —Ä–µ–π—Ç–∏–Ω–≥ –Ω–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω
        """
        with self.get_session() as session:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Å—Ç—É–¥–µ–Ω—Ç —Å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–º —Ä–µ–π—Ç–∏–Ω–≥–æ–º
            query = session.query(User).filter(User.user_type == UserType.STUDENT)
            
            if group_id:
                query = query.filter(User.group_id == group_id)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Å—Ç—É–¥–µ–Ω—Ç —Å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–º —Ä–µ–π—Ç–∏–Ω–≥–æ–º
            has_rating = query.filter(User.seminar_grade.isnot(None)).first()
            
            if not has_rating:
                return None
            
            # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
            students = query.all()
            
            if not students:
                return None
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ–π—Ç–∏–Ω–≥
            rating = []
            EXCLUSION_THRESHOLD = -15  # –ü–æ—Ä–æ–≥ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –∏–∑ —Ä–∞—Å—á–µ—Ç–∞
            for student in students:
                if student.seminar_grade is not None:
                    rating_entry = {
                        'user_id': student.id,
                        'username': student.username,
                        'score': student.score,
                        'grade': round(student.seminar_grade, 2),
                        'excluded': student.score <= EXCLUSION_THRESHOLD,
                        'group_id': student.group_id,
                        'group_name': student.group.name if student.group else '–ë–µ–∑ –≥—Ä—É–ø–ø—ã'
                    }
                    rating.append(rating_entry)
            
            # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é –æ—Ü–µ–Ω–∫–∏, –∑–∞—Ç–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é –±–∞–ª–ª–æ–≤
            rating.sort(key=lambda x: (x['grade'], x['score']), reverse=True)
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–Ω–≥–∏
            for rank, entry in enumerate(rating, start=1):
                entry['rank'] = rank
            
            return rating if rating else None

    def clear_ratings(self, group_id=None, rating_type='group'):
        """
        –û—á–∏—â–∞–µ—Ç —Ä–µ–π—Ç–∏–Ω–≥–∏ (—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç seminar_grade –≤ None)
        
        Args:
            group_id: ID –≥—Ä—É–ø–ø—ã (None –¥–ª—è –≤—Å–µ—Ö –≥—Ä—É–ø–ø)
            rating_type: –¢–∏–ø —Ä–µ–π—Ç–∏–Ω–≥–∞ ('group' –∏–ª–∏ 'overall')
        """
        with self.get_session() as session:
            query = session.query(User).filter(User.user_type == UserType.STUDENT)
            
            if group_id:
                query = query.filter(User.group_id == group_id)
            
            students = query.all()
            for student in students:
                student.seminar_grade = None

    def update_user_seminar_grade(self, user_id, grade):
        """
        –û–±–Ω–æ–≤–ª—è–µ—Ç –æ—Ü–µ–Ω–∫—É –∑–∞ —Å–µ–º–∏–Ω–∞—Ä—ã –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            grade: –û—Ü–µ–Ω–∫–∞ –∑–∞ —Å–µ–º–∏–Ω–∞—Ä—ã (0-10)
        """
        with self.get_session() as session:
            user = session.get(User, user_id)
            if user:
                user.seminar_grade = grade

    def calculate_all_ratings(self):
        """
        –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–π—Ç–∏–Ω–≥ –¥–ª—è –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤.
        ¬µ –∏ œÉ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –ø–æ –≤—Å–µ–º —Å—Ç—É–¥–µ–Ω—Ç–∞–º —Å –±–∞–ª–ª–∞–º–∏ > -15.
        """
        from .rating import calculate_grades
        
        with self.get_session() as session:
            # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
            all_students = session.query(User).filter(
                User.user_type == UserType.STUDENT
            ).all()
            
            if not all_students:
                return
            
            # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –æ—Ü–µ–Ω–æ–∫
            students_data = [(student.id, student.score) for student in all_students]
            
            # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ—Ü–µ–Ω–∫–∏
            grades_dict = calculate_grades(students_data)
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ü–µ–Ω–∫–∏ –≤ –ë–î
            for user_id, grade_info in grades_dict.items():
                user = session.get(User, user_id)
                if user:
                    grade = grade_info.get('grade', 0.0)
                    user.seminar_grade = grade

    def get_group_rating(self, group_id: int) -> List[Dict]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç —Ä–µ–π—Ç–∏–Ω–≥ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≤ –≥—Ä—É–ø–ø–µ –∏–∑ –ë–î –∏–ª–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç.
        –û—Ü–µ–Ω–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ (¬µ –∏ œÉ –ø–æ –≤—Å–µ–º —Å—Ç—É–¥–µ–Ω—Ç–∞–º).
        
        Args:
            group_id: ID –≥—Ä—É–ø–ø—ã
            
        Returns:
            –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å—Ç—É–¥–µ–Ω—Ç–∞—Ö –∏ –∏—Ö —Ä–µ–π—Ç–∏–Ω–≥–µ
        """
        # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –ë–î
        cached_rating = self.get_ratings_from_db(group_id=group_id, rating_type='group')
        if cached_rating:
            return cached_rating
        
        # –ï—Å–ª–∏ –≤ –ë–î –Ω–µ—Ç, –Ω—É–∂–Ω–æ —Å–Ω–∞—á–∞–ª–∞ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –æ—Ü–µ–Ω–∫–∏ –¥–ª—è –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ –æ—Ü–µ–Ω–∫–∏
        with self.get_session() as session:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Å—Ç—É–¥–µ–Ω—Ç —Å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–æ–π –æ—Ü–µ–Ω–∫–æ–π
            has_rating = session.query(User).filter(
                User.user_type == UserType.STUDENT,
                User.seminar_grade.isnot(None)
            ).first()
            
            if not has_rating:
                # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ—Ü–µ–Ω–∫–∏ –¥–ª—è –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
                self.calculate_all_ratings()
        
        # –¢–µ–ø–µ—Ä—å –ø–æ–ª—É—á–∞–µ–º —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≥—Ä—É–ø–ø—ã —Å –∏—Ö –æ—Ü–µ–Ω–∫–∞–º–∏
        with self.get_session() as session:
            group = session.get(Group, group_id)
            if not group:
                return []

            # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≥—Ä—É–ø–ø—ã
            students = [s for s in group.students if s.user_type == UserType.STUDENT]
            if not students:
                return []

            # –°–æ–∑–¥–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥ (—Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é –æ—Ü–µ–Ω–∫–∏, –∑–∞—Ç–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é –±–∞–ª–ª–æ–≤)
            rating = []
            sorted_students = sorted(
                students,
                key=lambda s: (s.seminar_grade or 0, s.score),
                reverse=True
            )

            EXCLUSION_THRESHOLD = -15
            for rank, student in enumerate(sorted_students, start=1):
                grade = student.seminar_grade or 0.0
                excluded = student.score <= EXCLUSION_THRESHOLD

                rating_entry = {
                    'user_id': student.id,
                    'username': student.username,
                    'score': student.score,
                    'rank': rank,
                    'grade': round(grade, 2),  # –û—Ü–µ–Ω–∫–∞ –≤ 10-–±–∞–ª–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ
                    'excluded': excluded,
                    'cdf_value': 0.0,
                    'group_id': group_id,
                    'group_name': group.name
                }
                rating.append(rating_entry)

            return rating

    def get_overall_rating(self) -> List[Dict]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –æ–±—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥ –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –ø–æ –≤—Å–µ–º –≥—Ä—É–ø–ø–∞–º –∏–∑ –ë–î –∏–ª–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç.
        –û—Ü–µ–Ω–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ (¬µ –∏ œÉ –ø–æ –≤—Å–µ–º —Å—Ç—É–¥–µ–Ω—Ç–∞–º).
        
        Returns:
            –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å—Ç—É–¥–µ–Ω—Ç–∞—Ö –∏ –∏—Ö —Ä–µ–π—Ç–∏–Ω–≥–µ
        """
        # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –ë–î
        cached_rating = self.get_ratings_from_db(group_id=None, rating_type='overall')
        if cached_rating:
            return cached_rating
        
        # –ï—Å–ª–∏ –≤ –ë–î –Ω–µ—Ç, —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
        self.calculate_all_ratings()
        
        # –¢–µ–ø–µ—Ä—å –ø–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ —Å –∏—Ö –æ—Ü–µ–Ω–∫–∞–º–∏
        with self.get_session() as session:
            # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
            students = session.query(User).filter(
                User.user_type == UserType.STUDENT
            ).all()

            if not students:
                return []

            # –°–æ–∑–¥–∞–µ–º –æ–±—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥ (—Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é –æ—Ü–µ–Ω–∫–∏, –∑–∞—Ç–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é –±–∞–ª–ª–æ–≤)
            rating = []
            sorted_students = sorted(
                students,
                key=lambda s: (s.seminar_grade or 0, s.score),
                reverse=True
            )

            EXCLUSION_THRESHOLD = -15
            for rank, student in enumerate(sorted_students, start=1):
                grade = student.seminar_grade or 0.0
                excluded = student.score <= EXCLUSION_THRESHOLD

                rating_entry = {
                    'user_id': student.id,
                    'username': student.username,
                    'score': student.score,
                    'rank': rank,
                    'grade': round(grade, 2),  # –û—Ü–µ–Ω–∫–∞ –≤ 10-–±–∞–ª–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ
                    'excluded': excluded,
                    'cdf_value': 0.0,
                    'group_id': student.group_id,
                    'group_name': student.group.name if student.group else '–ë–µ–∑ –≥—Ä—É–ø–ø—ã'
                }
                rating.append(rating_entry)

            return rating

    def recalculate_all_ratings(self):
        """
        –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –≤—Å–µ —Ä–µ–π—Ç–∏–Ω–≥–∏ (–≥—Ä—É–ø–ø–æ–≤—ã–µ –∏ –æ–±—â–∏–π) –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î.
        ¬µ –∏ œÉ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –ø–æ –≤—Å–µ–º —Å—Ç—É–¥–µ–Ω—Ç–∞–º —Å –±–∞–ª–ª–∞–º–∏ > -15.
        """
        # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ä–µ–π—Ç–∏–Ω–≥–∏
        self.clear_ratings()
        
        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ü–µ–Ω–∫–∏ –¥–ª—è –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
        self.calculate_all_ratings()

    def recalculate_group_rating(self, group_id: int):
        """
        –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ä–µ–π—Ç–∏–Ω–≥ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≥—Ä—É–ø–ø—ã.
        –ü–æ—Å–∫–æ–ª—å–∫—É ¬µ –∏ œÉ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –ø–æ –≤—Å–µ–º —Å—Ç—É–¥–µ–Ω—Ç–∞–º, –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –≤—Å–µ –æ—Ü–µ–Ω–∫–∏.
        
        Args:
            group_id: ID –≥—Ä—É–ø–ø—ã
        """
        # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Å–µ –æ—Ü–µ–Ω–∫–∏ (—Ç.–∫. ¬µ –∏ œÉ –∑–∞–≤–∏—Å—è—Ç –æ—Ç –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤)
        self.recalculate_all_ratings()

    def get_user_rating_position(self, user_id: int, by_group: bool = False) -> Optional[Dict]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –ø–æ–∑–∏—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ
        
        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            by_group: –ï—Å–ª–∏ True, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–∑–∏—Ü–∏—é –≤ –≥—Ä—É–ø–ø–µ, –∏–Ω–∞—á–µ –≤ –æ–±—â–µ–º —Ä–µ–π—Ç–∏–Ω–≥–µ
            
        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ None
        """
        if by_group:
            with self.get_session() as session:
                user = session.get(User, user_id)
                if not user or not user.group_id:
                    return None

                group_rating = self.get_group_rating(user.group_id)
                for entry in group_rating:
                    if entry['user_id'] == user_id:
                        return entry
        else:
            overall_rating = self.get_overall_rating()
            for entry in overall_rating:
                if entry['user_id'] == user_id:
                    return entry

        return None

    def get_top_students_by_group(self, group_id: int, limit: int = 10) -> List[Dict]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç —Ç–æ–ø —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≤ –≥—Ä—É–ø–ø–µ
        
        Args:
            group_id: ID –≥—Ä—É–ø–ø—ã
            limit: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≤ —Ç–æ–ø–µ
            
        Returns:
            –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ç–æ–ø —Å—Ç—É–¥–µ–Ω—Ç–∞—Ö
        """
        rating = self.get_group_rating(group_id)
        return rating[:limit]

    def get_top_students_overall(self, limit: int = 10) -> List[Dict]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç —Ç–æ–ø —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –ø–æ –≤—Å–µ–º –≥—Ä—É–ø–ø–∞–º
        
        Args:
            limit: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≤ —Ç–æ–ø–µ
            
        Returns:
            –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ç–æ–ø —Å—Ç—É–¥–µ–Ω—Ç–∞—Ö
        """
        rating = self.get_overall_rating()
        return rating[:limit]

    def get_rating_statistics(self, group_id: Optional[int] = None) -> Dict:
        """
        –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É
        
        Args:
            group_id: ID –≥—Ä—É–ø–ø—ã (–µ—Å–ª–∏ None, —Ç–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Å–µ–º –≥—Ä—É–ø–ø–∞–º)
            
        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
        """
        import numpy as np
        
        if group_id:
            rating = self.get_group_rating(group_id)
            group_name = rating[0]['group_name'] if rating else None
        else:
            rating = self.get_overall_rating()
            group_name = None

        if not rating:
            return {
                'group_id': group_id,
                'group_name': group_name,
                'total_students': 0,
                'excluded_students': 0,
                'mean_score': 0,
                'median_score': 0,
                'std_score': 0,
                'min_score': 0,
                'max_score': 0,
                'mean_grade': 0,
                'median_grade': 0
            }

        scores = [entry['score'] for entry in rating]
        grades = [entry['grade'] for entry in rating]
        excluded_count = sum(1 for entry in rating if entry.get('excluded', False))

        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–Ω—ã—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ (–¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è)
        included_scores = [entry['score'] for entry in rating if not entry.get('excluded', False)]
        mu = float(np.mean(included_scores)) if included_scores else 0.0
        sigma = float(np.std(included_scores, ddof=0)) if len(included_scores) > 1 else 0.0

        return {
            'group_id': group_id,
            'group_name': group_name,
            'total_students': len(rating),
            'excluded_students': excluded_count,
            'included_students': len(rating) - excluded_count,
            'mean_score': float(np.mean(scores)),
            'median_score': float(np.median(scores)),
            'std_score': float(np.std(scores)) if len(scores) > 1 else 0.0,
            'min_score': int(min(scores)),
            'max_score': int(max(scores)),
            'mean_grade': float(np.mean(grades)),
            'median_grade': float(np.median(grades)),
            'mu': mu,  # –°—Ä–µ–¥–Ω–µ–µ –¥–ª—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
            'sigma': sigma  # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –¥–ª—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
        }


# –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ë–î
db = DatabaseManager()


# –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
def drop_db():
    db.drop_tables()


def init_db():
    db.init_db()


def get_or_create_user(user_id, username):
    return db.get_or_create_user(user_id, username)


def register_user_request(user_id):
    db.register_user_request(user_id)


def can_user_request(user_id, max_attempts=100):
    return db.can_user_request(user_id, max_attempts)


def update_score(user_id, delta):
    return db.update_score(user_id, delta)


def get_score(user_id):
    return db.get_score(user_id)


def get_top_players(limit=3):
    return db.get_top_players(limit)


def get_user_position(user_id):
    return db.get_user_position(user_id)


def get_full_rating():
    return db.get_full_rating()


def get_user_requests_today(user_id):
    return db.get_user_requests_today(user_id)


def increment_correct(name):
    db.increment_correct(name)


def increment_wrong(name):
    db.increment_wrong(name)


def get_stats(name):
    return db.get_stats(name)


def get_top_strategies(limit=4):
    return db.get_top_strategies(limit)


# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã
def make_seminarist(user_id):
    """–ù–∞–∑–Ω–∞—á–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–µ–º–∏–Ω–∞—Ä–∏—Å—Ç–æ–º"""
    with db.get_session() as session:
        user = session.get(User, user_id)
        if user:
            user.user_type = UserType.SEMINARIAN
            return True
        return False


def make_admin(user_id):
    """–ù–∞–∑–Ω–∞—á–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º"""
    with db.get_session() as session:
        user = session.get(User, user_id)
        if user:
            user.user_type = UserType.ADMIN
            return True
        return False


def reset_to_student(user_id):
    """–°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞"""
    with db.get_session() as session:
        user = session.get(User, user_id)
        if user:
            user.user_type = UserType.STUDENT
            return True
        return False


def create_group(name, max_students=25):
    return db.create_group(name, max_students)


def set_user_group(user_id, group_id, changed_by_id=None):
    return db.set_user_group(user_id, group_id, changed_by_id)


def set_transfer_deadline(group_id, deadline, changed_by_id):
    return db.set_transfer_deadline(group_id, deadline, changed_by_id)


def get_available_groups_for_student(user_id):
    return db.get_available_groups_for_student(user_id)


# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–≤—è–∑–∏ –º–µ–∂–¥—É –º–æ–¥–µ–ª—è–º–∏ –ø–æ—Å–ª–µ –∏—Ö —Å–æ–∑–¥–∞–Ω–∏—è
def setup_relationships():
    """–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Å–≤—è–∑–∏ –º–µ–∂–¥—É –º–æ–¥–µ–ª—è–º–∏"""
    # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥–µ–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ
    from .users import User
    from .logs import ScoreChangeLog, OperationLog
    from .groups import Group

    # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–≤—è–∑–∏ User
    User.score_changes_made = relationship(
        "ScoreChangeLog",
        foreign_keys=[ScoreChangeLog.changed_by_id],
        back_populates="changed_by",
        cascade="all, delete-orphan"
    )

    User.score_changes_received = relationship(
        "ScoreChangeLog",
        foreign_keys=[ScoreChangeLog.user_id],
        back_populates="user",
        cascade="all, delete-orphan"
    )

    User.group = relationship("Group", back_populates="students")

    # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–≤—è–∑–∏ ScoreChangeLog
    ScoreChangeLog.user = relationship(
        "User",
        foreign_keys=[ScoreChangeLog.user_id],
        back_populates="score_changes_received"
    )
    ScoreChangeLog.changed_by = relationship(
        "User",
        foreign_keys=[ScoreChangeLog.changed_by_id],
        back_populates="score_changes_made"
    )

    # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–≤—è–∑–∏ OperationLog
    OperationLog.user = relationship("User", backref="operations")

    # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–≤—è–∑–∏ Group
    Group.students = relationship("User", back_populates="group")

    # –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
    configure_mappers()


# –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–≤—è–∑–µ–π
setup_relationships()


# –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–µ–π—Ç–∏–Ω–≥–æ–º (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
def get_group_rating(group_id: int) -> List[Dict]:
    """–ü–æ–ª—É—á–∞–µ—Ç —Ä–µ–π—Ç–∏–Ω–≥ –≥—Ä—É–ø–ø—ã"""
    return db.get_group_rating(group_id)


def get_overall_rating() -> List[Dict]:
    """–ü–æ–ª—É—á–∞–µ—Ç –æ–±—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥"""
    return db.get_overall_rating()


def get_user_rating_position(user_id: int, by_group: bool = False) -> Optional[Dict]:
    """–ü–æ–ª—É—á–∞–µ—Ç –ø–æ–∑–∏—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ"""
    return db.get_user_rating_position(user_id, by_group)


def get_top_students_by_group(group_id: int, limit: int = 10) -> List[Dict]:
    """–ü–æ–ª—É—á–∞–µ—Ç —Ç–æ–ø —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≤ –≥—Ä—É–ø–ø–µ"""
    return db.get_top_students_by_group(group_id, limit)


def get_top_students_overall(limit: int = 10) -> List[Dict]:
    """–ü–æ–ª—É—á–∞–µ—Ç —Ç–æ–ø —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –ø–æ –≤—Å–µ–º –≥—Ä—É–ø–ø–∞–º"""
    return db.get_top_students_overall(limit)


def get_rating_statistics(group_id: Optional[int] = None) -> Dict:
    """–ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É"""
    return db.get_rating_statistics(group_id)


def calculate_all_seminar_grades():
    """
    –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –æ—Ü–µ–Ω–∫–∏ –∑–∞ —Å–µ–º–∏–Ω–∞—Ä—ã –¥–ª—è –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤.
    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö —Å–µ–º–∏–Ω–∞—Ä–æ–≤.
    
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ:
    - –°—Ç—É–¥–µ–Ω—Ç—ã —Å –±–∞–ª–ª–∞–º–∏ <= -15 –ø–æ–ª—É—á–∞—é—Ç –æ—Ü–µ–Ω–∫—É 0
    - –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö: Norm.dist(x; ¬µ; œÉ; true) * 10
    –≥–¥–µ ¬µ –∏ œÉ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –ø–æ –≤—Å–µ–º —Å—Ç—É–¥–µ–Ω—Ç–∞–º —Å –±–∞–ª–ª–∞–º–∏ > -15
    """
    db.recalculate_all_ratings()